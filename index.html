<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>פנקס נאמן</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; margin: 0; }
        .order-card { 
            background: white; border-radius: 8px; margin: 12px 16px; padding: 0; 
            border: 1.5px solid #cbd5e1; position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); overflow: hidden;
        }
        .order-card::before {
            content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 12px;
            background-image: radial-gradient(#94a3b8 25%, transparent 25%);
            background-size: 12px 12px; background-position: center; border-left: 1px solid #f1f5f9; z-index: 10;
        }
        .card-header { padding: 8px 25px 8px 12px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 12px 25px 12px 12px; }
        .order-details-box {
            background: #fffef0; border: 1px solid #fde68a; border-radius: 6px; padding: 10px;
            color: #1e293b; font-weight: 600; line-height: 1.4; margin: 10px 0; font-size: 16px;
        }
        /* חותמת תשלום קטנה */
        .pay-badge {
            font-size: 11px; font-weight: 800; padding: 3px 8px; border-radius: 4px; cursor: pointer; border: 1px solid;
        }
        .pay-pending { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
        .pay-success { background: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }

        .btn-done { width: 100%; padding: 10px; border-radius: 8px; font-weight: 800; font-size: 14px; background: #1e293b; color: white; margin-top: 5px; }
        .action-icon-btn { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 200; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 12px; padding: 25px; }
    </style>
</head>
<body>

<div id="main-app">
    <div class="header-bg text-center p-6 bg-white border-b">
        <h1 class="text-2xl font-black text-slate-800">פנקס הזמנות</h1>
        <div class="text-sm font-bold text-slate-500">מאפה נאמן | <span class="text-blue-600">מגדל העמק</span></div>
    </div>

    <div id="orders-list" class="pb-32"></div>
</div>

<div id="confirm-modal" class="modal-overlay">
    <div class="modal-content text-center">
        <h2 id="confirm-title" class="text-xl font-black mb-2 text-slate-800">האם אתה בטוח?</h2>
        <p id="confirm-text" class="text-slate-500 font-bold mb-6 text-sm"></p>
        <div class="flex gap-3">
            <button onclick="closeConfirm()" class="flex-1 p-3 bg-slate-100 rounded-xl font-bold">ביטול</button>
            <button id="confirm-exec-btn" class="flex-1 p-3 bg-blue-600 text-white rounded-xl font-bold">אישור</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAVFQhIlCfJ6fyWaqKwyYR0Zmc7durLZXI",
      databaseURL: "https://neeman-orders-default-rtdb.europe-west1.firebasedatabase.app",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dbOrders = database.ref('orders');
    let allOrders = {};

    function init() { dbOrders.on('value', (s) => { allOrders = s.val() || {}; render(); }); }

    function render() {
        const list = document.getElementById('orders-list');
        const ids = Object.keys(allOrders).filter(id => !allOrders[id].completed);

        list.innerHTML = ids.map(id => {
            const o = allOrders[id];
            const d = new Date(o.deliveryDate);
            const dayName = d.toLocaleDateString('he-IL', {weekday: 'long'});
            const payClass = o.paid ? 'pay-success' : 'pay-pending';
            const payText = o.paid ? 'שולם ✓' : 'לא שולם';
            const wa = `https://wa.me/972${o.phone?.replace(/^0/,'')}?text=${encodeURIComponent('היי '+o.name+', בקשר להזמנה שלך ממאפה נאמן')}`;

            return `
                <div class="order-card">
                    <div class="card-header">
                        <span class="text-sm font-extrabold">${dayName} ${o.deliveryDate?.split('-').reverse().slice(0,2).join('/')} | <span class="text-blue-600">${o.deliveryTime}</span></span>
                        <button onclick="customConfirm('למחוק לצמיתות?', () => deleteOrder('${id}'))" class="text-slate-300 text-xs">✕ מחיקה</button>
                    </div>
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="text-xl font-black text-slate-800">${o.name}</h3>
                                    <span onclick="customConfirm('לשנות סטטוס תשלום?', () => togglePay('${id}'))" class="pay-badge ${payClass}">${payText}</span>
                                </div>
                                <a href="tel:${o.phone}" class="text-blue-600 font-bold text-base">${o.phone}</a>
                            </div>
                            <div class="flex gap-2">
                                <a href="${wa}" target="_blank" class="action-icon-btn bg-green-500 border-none"><img src="https://img.icons8.com/color/48/whatsapp.png" width="18"></a>
                            </div>
                        </div>
                        <div class="order-details-box whitespace-pre-wrap">${o.details}</div>
                        <button onclick="customConfirm('לסמן כבוצע?', () => toggleComplete('${id}'))" class="btn-done">סמן כבוצע ✅</button>
                        <div class="text-[10px] text-slate-400 mt-2">רשם/ה: ${o.createdBy || 'מערכת'}</div>
                    </div>
                </div>`;
        }).join('');
    }

    function customConfirm(text, callback) {
        document.getElementById('confirm-text').innerText = text;
        const btn = document.getElementById('confirm-exec-btn');
        btn.onclick = () => { callback(); closeConfirm(); };
        document.getElementById('confirm-modal').style.display = 'flex';
    }
    function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; }
    function togglePay(id) { dbOrders.child(id).update({ paid: !allOrders[id].paid }); }
    function toggleComplete(id) { dbOrders.child(id).update({ completed: true }); }
    function deleteOrder(id) { dbOrders.child(id).remove(); }

    init();
</script>
</body>
</html>
